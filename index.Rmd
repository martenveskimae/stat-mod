---
title: "Statistiline modelleerimine 2017"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
author: "Märten Veskimäe & Mihkel Solvak"
output:
  prettydoc::html_pretty:
    theme: cayman
    toc: true
    # toc_float: true
    # code_folding: show
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      warning = F,
                      message = F,
                      comment = NA,
                      fig.align="center")
Sys.setlocale("LC_ALL", "UTF-8")
```

# Sissejuhatus R keelde

## Teaser
- <a href="https://martenveskimae.github.io/stat-mod/rahalised_annetused.html">Rahalised annetused erakondadele</a>

## Paketid

```{r}
library(tidyverse)
library(ggthemes)
```

## Taustaks

R on statistikale ja andmete visualiseerimisele suunatud vabavaraline programmeerimiskeel. R loodi 90ndate alguses S-i baasile ning on tasapisi muutunud üheks enimkasutatavaks statistika tarkvaraks.

![R Passes SPSS in Scholarly Use, Stata Growing Rapidly](images/software.png)
<a href="http://r4stats.com/2014/08/20/r-passes-spss-in-scholarly-use-stata-growing-rapidly/">R Passes SPSS in Scholarly Use, Stata Growing Rapidly (2014)</a>

R-il on olulisi eeliseid mitmete teiste statistikatarkvarade ees:

- R on eeskätt programmeerimiskeel, mis tähendab, et see võimaldab luua uusi funktsioone vastavalt eesseisvale probleemile;
- R on vabavaraline ning kasvava populaarsusega, mis tähendab, et uute meetodid jõuavad R-i kasutajateni enne teisi;
- R jookseb kõikidel levinud OS-idel ning on tasuta kättesaadav;
- R ühildub mitmete teiste keeltega, mis teeb selle laiemalt kasutatavaks (näiteks käesolev **markdown-i** dokument);
- R pakub visualiseerimisel tõenäoliselt parimat tasakaalu lihtsuse ja esteetilisuse vahel;
- R on tõenäoliselt üks parimaid vahendeid statistika tegemiseks ka aastakümne pärast, mis tähendab, et selle õppimiseks kulutatud aeg pole raisatud.

Sellega seoses on sel ka miinuseid:

- nõuab uue keele õppimist, mis võib olla alguses keeruline;
- aeg ajalt esineb uuemates pakettides vigu, mis tähendab, et tuleb olla tähelepanelik;
- seab kõrgemad nõuded meetodite tundmisele.

### Intervjuud:
- <a href="https://www.youtube.com/watch?v=jk9S3RTAl38&ab_channel=StatisticalLearning">John Chambers, S-i looja</a>

## Installeerimiseks

R-i kasutamiseks piisab vaid R-i "mootori" installerimisest, kuid mugavam on kasutada graafilist kasutajaliidest, näiteks R-Studiot.

- <a href="https://www.r-project.org">R</a></br>
- <a href="https://www.rstudio.com/products/rstudio/">R studio (GUI)</a>

Kuna R on vabavaraline tarkvara, siis on mitmete R-i funktsioonide kasutamiseks vajalik need esmalt alla laadida. See toimub R-i keskkonnas `install.packages(...)` abil (nt `install.packages("tidyverse")`), mispuhul **pakett** on funktsioonide kogum. Vajaminevate pakettide peale hetkel mõtlema ei pea, need tulevad jooksvalt praktikumide käigus.

## Tööpõhimõtted
### Objektid

R-i põhiline töövahend on **objekt**, mis võib sisaldada nii funktsioone kui andmeid. Objekte saab ise luua `<-` või `=` märkide abil (`<-` on mõnevõrra kindlam meetod ja mõned soovitavad kasutada seda. Üldjuhul, sh selle aine raames, piisab ka `=` kasutamisest).

```{r}
x = 5
x
```

Kui soovime siduda rohkem andmeid ühe objektiga, on võimalik luua **vektor** (jada / ühedimensionaalne maatriks).
```{r}
x <- c(5, 12.3, 3:10)
x
```

Objekt võib saada sisendi ka teisest objektidest. Samuti võib teha objektidega tehteid.
```{r}
y = x - 5
y
```

Objektiks võib olla ka funktsioon.
```{r}
lahuta.viis = function(x){
  tmp = x - 5
  return(tmp)
}

y = lahuta.viis(x)
y
```

### Põhilised andmetüübid

Numbrid:
```{r}
x = 1
str(x)
```

Tähemärgid (numbrid muudetakse tähemärkideks):
```{r}
x = c("a", "b", 1, 2)
str(x)
```

Faktorid (identsed elemendid saavad sama koodi):
```{r}
x = as.factor(c("a", "b", "1", "2", "a", "2"))
str(x)
```

Kuupäevad:
```{r}
x = as.Date("2017-09-01")
str(x)
```

Kuupäevade puhul on oluline jälgida formaati. Vaikimisi on selleks **yyyy-mm-dd**, kuid kui sisseloetavad andmed on teises formaadis, tuleks see `as.Date(...)` käskluses täpsustada `format` või `origin` argumentidega. Formaatidest pikemalt: <a href="http://www.statmethods.net/input/dates.html">Date Values</a>.

```{r}
as.Date("01-09-2017", format="%d-%m-%Y")
as.Date(17410, origin="1970-01-01")
```

### Andmetabelid

Seni vaadatud jadad on olnud kõik ühedimensioonilised, ent andmed võivad olla ka mitmedimensionaalsed. Enimlevinud mitmedimensioonilised formaadid on **andmetabelid** ja **maatriksid**, millest peamiselt keskendume esimesele. Maatriks on kahedimensionaalne vektor, mis on justkui mitu vektorit kokku liidetuna, kuid kõik vektorid peavad olema sama liiki andmetega.

```{r}
matrix(1:9, nrow=3, byrow = T)
matrix(letters[1:9], nrow=3, byrow = T)
```

Mitu samapikkust vektorit saab liita kokku üheks ka andmetabeliks ehk data frameiks (`data.frame(...)`). Data frame'i erinevus seisneb selles, et veerud võivad sisaldada eritüüpi andmeid (nt üks veerg on numbriline, teine sisaldab faktoreid jne).
```{r}
x = c(1:4)
y = c("Audi", "DAF", "Ford", "GAZ")
z = x-5

df = data.frame(tunnus.1 = x,
                tunnus.2 = y,
                tunnus.3 = z)
df
```

Andmetabelite tunnuseid (ehk veerge) saab kätte ka vektorina kasutades `$` märki:
```{r}
df$tunnus.2
```

Võimalik on kasutada ka indeksi (järjekorra) numbrit kandilistes sulgudes. Andmetabelite puhul on esimene number rea number ning koma järel veeru number. Vektori puhul piisab vaid rea numbrist.
```{r}
df[,2]
df["tunnus.2"]
df[1,]["tunnus.2"]
df[1,2]
df$tunnus.2[2]
```

### Listid

Kõiki erinevaid objekte saab koondada listidesse (`list(...)`). List on hea koondamaks erinevate pikkustega või erineva iseloomuga, kuid samateemalisi andmeid. Tihti võib liste kohata erinevate funktsioonide väljundites.

```{r}
ls = list(df)
ls[[2]] = c(1:10)
ls[[3]] = y[2:4]

ls
```

### Funktsioonid objektide kohta

Kõikide objektide puhul:

- `str(...)` - objekti struktuur
- `typeof(...)` - storage mode
- `is.numeric(...)` - kas on...
- `is.character(...)`
- `is.factor(...)`
- `is.function(...)`
- `is.logical(...)`

...

Vektori puhul:

- `length(...)` - vektori pikkus

Data frame'i puhul:

- `dim(...)` - data frame'i dimensioonid (ridu, veerge)
- `nrow(...)` - ridade arv
- `ncol(...)` - veergude arv

Formaadi muutmiseks:

- `as.vector(...)` - vektor
- `as.matrix(...)` - maatriks
- `as.Date(...)` - kuupäev
- `as.data.frame(...)` - data frame
- `as.list(...)` - list

## Andmestike laadimine

R suudab lugeda sisse enamikke levinud andmefailide formaate, kuid kõige sagedasemalt kasutatakse .csv (*comma separated values*). Andmestike sisselugemiseks on erinevaid funktsioone, kuid .csv-de puhul piisab `read.csv(...)`. `read.csv(...)` võimaldab muu hulgas määratleda, kuidas on eraldatud erinevad veerud (`sep`; koma, semikooloni vm abil) ja mida kasutatakse komakohtade eraldamiseks (`dec`; punkt, koma vm). See võib olla oluline, kuna erinevad programmid erinevatel OS-idel võivad kasutada erinevaid standardeid.

### Internetist

```{r}
url = "https://martenveskimae.github.io/stat-mod/party_dataset.csv"
df = read.csv(url, sep=";", dec = ",")
```

Andmestiku vaatamiseks võib küsida tervet andmestikku, aga võib ka küsida esimesi või viimaseid ridu. Selleks saab kasutada nii indeksi kui ka eraldi funktsioone `head(...)` ja `tail(...)`.

```{r}
df[1:6, 1:4]

head(df[,1:4])
tail(df[,1:4])
```

Et näha, millised tunnused andmestikus on, võib küsida tunnuste pealkirju `colnames(...)` funktsiooiga.

```{r}
colnames(df)
```

### Kohalikult kettalt

Kohalikult kettalt andmestike laadimiseks tuleb märkida ära andmestiku asukoht kettal. Selle lihtsustamiseks on otstarbekas märkida ära töökeskonna asukoht.

Olemasoleva asukoha nägemiseks on funktsioon `getwd()`.
```{r}
getwd()
```

Kui tahta seda muuta, saab kasutada `setwd(...)` funktsiooni, kus argumendiks on soovitud uus asukoht.

## Andmetega tutvumine

Kokkuvõtvaid andmed nii andmetabelite kui teiste andmeformaatide kohta näeb funktsiooniga `summary(...)`.
```{r}
summary(df)
```

Faktortunnuste puhul võib pakkuda huvi, millised erinevad kategooriad on andmestikus esindatud. Näiteks võime vaadata, millised erakonnad andmestikus leiduvad.
```{r}
levels(df$party)
```

Kui soovida täpsemat ülevaadet, näiteks, mitu andmepukti on iga erakonnaga seotud, siis selleks on hea kasutada paketti **tidyverse**. Tidyverse hõlmab endas mitmeid erinevaid, kuid omavahel ühilduvaid pakette. Üks neist, **dplyr**, pakub mitmeid funktsioone andmete mugavaks töötlemiseks (eeskätt filtreerimine, grupeerimine, tunnuste muutmine jne). Teine oluline eelis tuleneb paketist **magrittr**, mis võimaldab käsklusi sisestada jadana (ing.k *pipe*). See kiirendab tööprotsessi ja muudab R-i koodi kergemini jälgitavaks. Pipe'ide kasutamiseks tuleb kahe funktsiooni vahel lisada `%>%` sümbolid. Enne näite juurde liikumist on vajalik tidyverse aktiveerida, milleks on funktsioon `library(...)`.

```{r}
library(tidyverse)
```

Pipe'i näide võib olla järgnev:
```{r}
c(1:10) %>% lahuta.viis()
```

Järgnevalt tutvume, mitu rida on seotud üksikute erakondadega (sagedustabel). 
```{r}
df %>%
  group_by(party) %>%
  summarize(n = n())
```

**dplyr** kohta leiab rohkem informatsiooni siit: <a href="http://genomicsclass.github.io/book/pages/dplyr_tutorial.html">dplyr tutorial</a>

### Kirjeldavad joonised

Kõige kiirem viis andmete visualiseerimiseks on kasutada funktsioone `plot(...)` või `hist(...)`, kus tuleb määratleda telje/telgede väärtused.

```{r}
plot(df$year, df$support)
```

```{r}
hist(df$support)
```

Paraku ei ole antud funktsioonid väga mugavad tidyverse'is kasutamiseks ning kujunduse muutmine on piiratud võimalustega. Kõige enim levinud viis andmete visualiseerimiseks R-i keskkonnas on paketiga **ggplot2**, mis on samuti tidyverse'i osa.

```{r}
df %>%
  filter(party=="ref") %>%
  ggplot() +
  geom_point(aes(year, support))
```

```{r}
df %>%
  filter(party=="ref") %>%
  ggplot() +
  geom_histogram(aes(support))
```

Kujunduse kiireks muutmiseks on erinevad valmislahendused, mis on kättesaadavad **ggthemes** paketiga.
```{r}
library(ggthemes)

df %>%
  filter(party=="ref") %>%
  ggplot() +
  geom_point(aes(year, support)) +
  theme_bw()
```

# Jaotus ja keskmised

## Paketid

```{r}
library(tidyverse)
library(ggthemes)
library(moments)
```

## Andmestik

```{r}
url = "https://martenveskimae.github.io/stat-mod/party_dataset.csv"
df = read.csv(url, sep=";", dec = ",")
```


## Histogramm
Vaatame jaotuste järsakust ja sümmeetrilisust visuaalselt histogrammi abil. `geom_histogram(...)` annab vaikimisi sagedusjaotuse, kuid on võimalik valida ka protsente või tõenäosustihedust.

```{r}
df %>%
  ggplot() +
  geom_histogram(aes(support, ..count../sum(..count..))) +
  geom_line(aes(support, ..density../100), stat = "density") +
  scale_y_continuous(labels=scales::percent) +
  scale_x_continuous(labels=scales::percent) +
  labs(y="protsent") +
  theme_bw()
```

**ggplot** võimaldab luua eraldi joonised erinevate gruppide jaoks kasutades `facet_wrap(...)` käsklust.

```{r}
df %>%
  ggplot() +
  geom_histogram(aes(support, ..count../sum(..count..))) +
  geom_line(aes(support, ..density../100), stat = "density") +
  facet_wrap(~party) +
  scale_y_continuous(labels=scales::percent) +
  scale_x_continuous(labels=scales::percent) +
  labs(y="protsent") +
  theme_bw()
```

Silmas tuleb pidada, et sel puhul kalkuleerib **ggplot** tulpade laiused ja hulga üle kõikide kuvatud jooniste, mistõttu erinevad need üksikult kuvatud joonistest. Tulpade hulga ja laiuste kontrollimiseks on argumendid `bins` ja `binwidth`, millest esimene määrab tulpade hulga ja teine laiused. Neid käsklusi ei saa korraga kasutada (binwidth kirjutab binsi üle).

```{r}
df %>%
  ggplot() +
  geom_histogram(aes(support, ..count../sum(..count..)), bins=10, binwidth=0.03) +
  geom_line(aes(support, ..density../100), stat = "density") +
  facet_wrap(~party) +
  scale_y_continuous(labels=scales::percent) +
  scale_x_continuous(labels=scales::percent) +
  labs(y="protsent") +
  theme_bw()
```

## Järsakuse- ja assümmeetriakordaja

Vaatame järsakust ja sümmeetrilisust ka numbriliselt nn järsakuse- ja assümmeetriakordaja abil. Seda võimaldab pakett **moments**, kust leiame käsklused `skewness(...)` ja `kurtosis(...)`. Kuna soovime rakendada antud käsklusi kõigi gruppide (erakondade) peale eraldi, siis tuleks andmestik esmalt filtreerida grupeerimistunnuse alusel (party) ning alles seejärel rakendada antud käsklusi. Kõige lihtsam (kuid mitte kõige efektiivsem) viis selleks on **for loop** meetod:

```{r}
parties = as.character(unique(df$party))
s = c()
k = c()
for(i in 1:length(parties)){
  s[length(s)+1] = skewness(df$support[df$party==parties[i]], na.rm=T)
  k[length(k)+1] = kurtosis(df$support[df$party==parties[i]], na.rm=T)
}
names(s) = parties
names(k) = parties
s;k
```


Sama tulemusega saab aga lihtsamalt kätte kasutades `apply(...)` käsklust, mis jäljendab eelneva meetodi loogikat.
```{r}
s = sapply(as.character(unique(df$party)), function(x) skewness(df$support[df$party==x], na.rm=T))
k = sapply(as.character(unique(df$party)), function(x) kurtosis(df$support[df$party==x], na.rm=T))
s;k
```

## Keskmine, mediaan ja mood

Keskmise ja mediaani leidmine on R-is lihtne `mean(...)` ja `median(...)` käskluste abil:
```{r}
mean = sapply(as.character(unique(df$party)), function(x) mean(df$support[df$party==x], na.rm=T))
median = sapply(as.character(unique(df$party)), function(x) median(df$support[df$party==x], na.rm=T))
mean;median
```

Moodi, ehk kõige sagedamini esineva väärtuse leidmiseks eraldi käsklus puudub, ent seda on lihtne leida sagedustabelist.
```{r}
df %>%
  group_by(party, support) %>%
  summarise(n = n()) %>%
  na.omit() %>%
  group_by(party) %>%
  summarise(mode = support[n==max(n)][1])
```

**dplyri** saab kasutada ka keskmise ja mediaani leidmiseks.
```{r}
df %>%
  group_by(party) %>%
  summarise(mean = mean(support,na.rm=T),
            median = median(support,na.rm=T))
```

Viimaks võib kanda leitud väärtused histogrammile, et neid visuaalselt kõrvutada. Kuigi **ggplot** oskab lisada joonistele funktsioone, ei suuda ta praeguses versioonis kuvada eraldi funktsioone eraldi gruppidele (nt kasutades `facet_wrap(~party)`). Otstarbekas on sellisel juhul teha uus andmetabel keskmiste väärtustega.

```{r}
keskmised = df %>%
  group_by(party, support) %>%
  summarise(n = n()) %>%
  na.omit() %>%
  group_by(party) %>%
  summarise(mean = mean(support),
            median = median(support),
            mode = support[n==max(n)][1])

df %>%
  ggplot() +
  geom_histogram(aes(support)) +
  geom_line(aes(support, ..density..), stat = "density") +
  facet_wrap(~party) +
  geom_vline(data=keskmised,aes(xintercept=mean, color="Keskmine")) +
  geom_vline(data=keskmised,aes(xintercept=median, color="Mediaan")) +
  geom_vline(data=keskmised,aes(xintercept=mode, color="Mood")) +
  scale_x_continuous(labels=scales::percent) +
  theme_bw()
```

# Usaldusvahemikud
# Keskmiste võrdlus
# Korrelatsioon
# Lineaarne regressioon
# Logistiline regressioon
