{
    "collab_server" : "",
    "contents" : "---\ntitle: 'Rahalised annetused: ref'\ndate: \"`r format(Sys.time(), '%d-%m-%Y')`\"\nauthor: \"Märten Veskimäe\"\noutput:\n  html_document:\n    toc: true\n    toc_float: true\n    code_folding: show\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = T,\n                      warning = F,\n                      message = F,\n                      comment = NA,\n                      fig.align=\"center\")\nSys.setlocale(\"LC_ALL\", \"UTF-8\")\n```\n\n###Vajaminevad paketid\n```{r paketid}\nlibrary(tidyverse)\nlibrary(ggthemes)\nlibrary(htmltab)\nlibrary(lubridate)\nlibrary(zoo)\nlibrary(stargazer)\nSys.setlocale(\"LC_ALL\", \"UTF-8\")\n```\n\n###Funktsioon vanuse arvutamiseks\n```{r vanus}\ncalc.age = function(dob, age.day = today(), units = \"years\", floor = T) {\n  age = interval(dob, age.day) / duration(num = 1, units = units)\n  if (floor) return(as.integer(floor(age)))\n  return(age)\n}\n```\n\n###Andmete \"kraapimise\" parameetrid\n```{r}\nurls = expand.grid(period = seq(2013, format(Sys.time(), \"%Y\"), 1),\n                   q = 1:4,\n                   code = c(67, 68, 55, 1381, 56, 57))\n```\n\n###Andmestiku allalaadimine ja töötlemine\n```{r, eval = FALSE}\ndf = plyr::ldply(1:nrow(urls), function(i){\n  url = paste0(\"http://www.erjk.ee/et/aruanded/tulude-ja-laekumiste-paringud?period=\",\n               urls$period[i],\"&party=\",urls$code[i],\"&person=all&group=all&quarter=q\",urls$q[i])\n  \n  tmp = tryCatch(htmltab(url,1), error=function(e) NULL)\n  if(is.null(tmp)) return(NULL)\n  \n  tmp = tmp %>%\n    head(-2) %>%\n    mutate(membership.fees = as.numeric(gsub(\" \", \"\", Liikmemaks, fixed = T)),\n           donations = as.numeric(gsub(\" \", \"\", `Rahaline annetus`, fixed = T)),\n           party = case_when(urls$code[i] == 55 ~ \"ref\",\n                             urls$code[i] == 67 ~ \"kesk\",\n                             urls$code[i] == 57 ~ \"sde\",\n                             urls$code[i] == 56 ~ \"irl\",\n                             urls$code[i] == 1381 ~ \"vaba\",\n                             urls$code[i] == 68 ~ \"ekre\"),\n           date = as.Date(as.yearqtr(paste(urls$period[i],urls$q[i]),format=\"%Y %q\")),\n           name = tools::toTitleCase(tolower(gsub( \" *\\\\(.*?\\\\) *\", \"\", V1))),\n           bday = as.Date(gsub(\"(?<=\\\\()[^()]*(?=\\\\))(*SKIP)(*F)|.\", \"\", V1, perl=T),\n                          format=\"%d.%m.%Y\"),\n           age = calc.age(bday, date)) %>%\n    select(name, bday, age, date, party, membership.fees, donations)\n  \n    return(tmp)\n  })\n```\n\n```{r, echo=FALSE}\nload(\"df.Rda\")\ndf = df %>% mutate(donations = `Rahaline annetus`,\n                   membership.fees = Liikmemaks) %>%\n  select(name, bday, age, date, party, membership.fees, donations)\n```\n\n\n```{r}\nhead(df)\n```\n\n###Valimistsükli tunnuste loomine ja allalaetud andmete filtreerimine\n```{r}\ncycles = data.frame(date = seq.Date(as.Date(\"2011-03-01\"), as.Date(\"2018-01-01\"), by = \"month\"),\n                    np = rep(1:48, 3)[1:83]/48,\n                    local = rep(1:48, 3)[18:100]/48)\n\nlm.data = df %>%\n  filter(party == \"ref\") %>%\n  group_by(date) %>%\n  summarise(donations = sum(donations)) %>%\n  left_join(., cycles, by=\"date\")\n```\n\n###Algandmed\n```{r}\nlm.data %>%\n  ggplot() +\n  geom_line(aes(date, donations)) +\n  geom_point(aes(date, donations), size=.8) +\n  theme_bw()\n```\n\n###Regressioonivõrrand rahaliste annetuste prognoosimiseks\n```{r}\nlm.donations = lm(donations ~ np + poly(np,2) + local + poly(local,2), lm.data)\n```\n\n```{r, results=\"asis\"}\nstargazer(lm.donations, type=\"html\")\n```\n\n###Tühja andmetabeli tegemine prognoosiks\n```{r}\nprediction.data = data.frame(date = seq.Date(as.Date(\"2013-01-01\"), as.Date(\"2018-01-01\"), by = \"quarter\")) %>%\n  left_join(., cycles, by=\"date\")\n```\n\n###Prognoosimine ja visualiseerimine\n```{r}\nprediction.data %>%\n  mutate(yhat = predict(lm.donations, .)) %>%\n  left_join(., lm.data) %>%\n  ggplot() +\n  geom_line(aes(date, donations)) +\n  geom_point(aes(date, donations), size=.8) +\n  geom_line(aes(date, yhat), color=\"steelblue\") +\n  geom_point(aes(date, yhat), size=.8, color=\"steelblue\") +\n  theme_bw()\n```\n\n",
    "created" : 1504090108043.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1905754062",
    "id" : "1A8B2966",
    "lastKnownWriteTime" : 1504090116,
    "last_content_update" : 1504090116332,
    "path" : "~/GitHub/stat-mod/rahalised_annetused.Rmd",
    "project_path" : "rahalised_annetused.Rmd",
    "properties" : {
        "last_setup_crc32" : "2600A519cee35878"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}